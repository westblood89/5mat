<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Matematik Ligi — 5. Sınıflar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tab-content{display:none}.tab-content.active{display:block}
    .qualified{background-color:#dcfce7!important}
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <div class="flex items-center justify-center mb-4">
        <div class="text-4xl mr-4">🎒</div>
        <div class="text-center">
          <h1 class="text-3xl font-bold text-indigo-800 mb-2">🏆 Matematik Ligi</h1>
          <div class="text-center"><span class="text-gray-600 font-medium text-xl">5. Sınıflar Grup Aşaması</span></div>
        </div>
        <div class="text-4xl ml-4">📚</div>
      </div>
      <div class="flex justify-center items-center space-x-4 text-2xl">
        <span>✏️</span><span>📝</span><span>🧮</span><span>📐</span><span>📏</span>
        <span>🔢</span><span>➕</span><span>➖</span><span>✖️</span><span>➗</span>
      </div>
    </div>

    <!-- Tabs -->
    <div class="bg-white rounded-lg shadow-lg mb-6">
      <div class="flex flex-wrap border-b">
        <button onclick="showTab('standings', this)" class="tab-btn px-4 py-3 font-medium text-indigo-600 border-b-2 border-indigo-600">📊 Puan Durumu</button>
        <button onclick="showTab('fixtures', this)" class="tab-btn px-4 py-3 font-medium text-gray-500 hover:text-indigo-600">📅 Fikstür</button>
      </div>
    </div>

    <!-- Standings -->
    <div id="standings" class="tab-content active">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Puan Durumu</h2>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Grup Seç:</label>
          <select id="standingsGroupSelect" onchange="showStandings()" class="border border-gray-300 rounded-lg px-3 py-2">
            <option value="">Grup seçin...</option>
          </select>
        </div>
        <div id="standingsContent"></div>
      </div>
    </div>

    <!-- Fixtures -->
    <div id="fixtures" class="tab-content">
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Fikstür ve Sonuçlar</h2>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Grup Seç:</label>
          <select id="fixtureGroupSelect" onchange="showFixtures()" class="border border-gray-300 rounded-lg px-3 py-2">
            <option value="">Grup seçin...</option>
          </select>
        </div>

        <!-- Backup controls (bu sekmenin içinde) -->
        <div class="mb-4 flex gap-2">
          <button onclick="downloadBackup()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-sm">💾 Yedeği İndir</button>
          <label class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-sm cursor-pointer">📤 Yedekten Yükle
            <input type="file" id="restoreInput" accept="application/json" class="hidden" onchange="restoreFromFile(event)">
          </label>
        </div>

        <div id="fixtureContent"></div>
      </div>
    </div>
  </div>

  <script>
    // ---- Ayarlar (5. sınıflar için benzersiz anahtar) ----
    const STORAGE_KEY = 'mathLeagueData_5';

    // ---- Veri Modeli ----
    let leagueData = { groups: {}, fixtures: {}, results: {} };

    // ---- Yedek oluştur/indir/yükle ----
    function createDownloadableBackup(){
      const blob = new Blob([JSON.stringify(leagueData,null,2)],{type:'application/json'});
      let a = document.getElementById('downloadBackup');
      if(!a){ a=document.createElement('a'); a.id='downloadBackup'; a.style.display='none'; document.body.appendChild(a); }
      a.href = URL.createObjectURL(blob);
      a.download = `matlig_5sinif_yedek_${new Date().toISOString().slice(0,10)}.json`;
    }
    function downloadBackup(){ const a=document.getElementById('downloadBackup'); if(a) a.click(); }
    function restoreFromFile(ev){
      const f = ev.target.files?.[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const obj = JSON.parse(reader.result);
          if(obj && obj.groups && obj.fixtures && obj.results){
            leagueData = obj; saveData();
            populateGroupSelects(); showFixtures(); showStandings();
            alert('✅ Yedekten yüklendi');
          }else alert('❌ Geçersiz yedek dosyası');
        }catch{ alert('❌ Dosya okunamadı'); }
        ev.target.value='';
      };
      reader.readAsText(f);
    }

    // ---- Kaydet/Yükle ----
    function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(leagueData)); createDownloadableBackup(); }
    function loadData(){
      const saved = localStorage.getItem(STORAGE_KEY);
      if(saved){ try{ leagueData = JSON.parse(saved) || leagueData; }catch{} }
      if(!saved || !leagueData.groups || Object.keys(leagueData.groups).length===0){
        initializeWithSampleData(); saveData();
      }
      populateGroupSelects();
    }

    // ---- 5. Sınıf Grupları ----
    function initializeWithSampleData(){
      const G = {};
      G['A']=['ALİ OĞUZ','NİKAN KAYA','ADA USTA','EGE SARI','PERİSU MURATHAN','ALP EFE IŞIK','HÜSEYİN RÜZGAR SAĞLAM','AHMET ASAF ÖZEN'];
      G['B']=['BARTU UÇAR','ÖMER BARAN AYTEMÜR','ALARA DERİN ÖZYER','ELİF YILMAZ','POYRAZ AHMED AYDINALP','ALYA EKMEN','KUTAY ÇOLAK','ALYA ÖZPİ'];
      G['C']=['ÇINAR BERKAY KILINÇ','RÜZGAR KIRALİ','ALİ ATİLA','EMİR ÜNAL','SEDEF GÜNEŞLİ','AYAZ ALİ YILDIZ','KUZEY KURTULDU','ARAS ARKAN'];
      G['D']=['DEMİR TÜLÜ','YUSUF YANKI EKİZ','ALP KORALAY','EMRE ÖNEY','SERHAT YAMAN AĞIRMAN','AYŞE ADA YEŞİLYURT','MAHMUTALİ AYDIN','ASİL TURAN'];
      G['E']=['DERİN ASEL ASLAN','ZEHRA DEFNE AKBEY','ALP METE KURU','FATMA ERVA TAŞDEMİR','TUNA DEMİRER','BİLGE NAZ ÖZCAN','MELİS COŞKUNER','BEREN BULCA'];
      G['F']=['DOĞA ATEŞ','ZEYNEP ALYA EROL','ALP ÖZ','İPEK NAZLI DOLU','YİĞİT ALİ KOÇ','BÜRÇE TUBA KURT','MİHRİMAH ELA YILDIRIM','BEYZA BETÜL HORUZ'];
      G['G']=['DURU İŞERİ','ZEYNEP KIZILKAYA','ARYA SAĞLIK','KEREM IŞIK','YİĞİT ARDA MART','CAN AYTAK','MİRA DAL','CAN AKTAŞ'];
      G['H']=['ECE ÜSTÜNDAĞ','ZEYNEP VURUCU','AYAZ SANLI','KEREM TUNÇYÜREK','ZEYNEP BİLİR','CEM ÇINAR DUMAN','MİRA ŞAHİN','DAĞHAN EROL ZİNDAR'];
      G['I']=['ELA ALDEMİR','BEYZA KARTAL','KÜRŞAT GÖKDENİZ BEKTAŞ','DEFNE ÇİM','NİL TABAK','DEFNE AYTAK','KEREM ÖZTÜRK','AHMET MUTAY ERDEM'];
      G['J']=['EREN ÖZEL','ÇAĞAN AKÇA','MELİSA ESMER','DENİZ ÇİM','NİSAN ÖZLÜK','DEFNE TINAZ','MEHMET ALİ ÇEMBERCİ','BEREN NEZİROĞULULARI'];
      G['K']=['İNAN ALDEMİR','DEFNE TOPAL','MERT ÖZEL','ELA EMİROĞLU','SELİS TAHA','DENİZ PINDIKOĞLU','MERYEM ŞEN','DEFNE ERÇEL'];
      G['L']=['KAAN ÇALIŞKAN','DEMİR ALİ KAYA','MUSTAFA KADİR ARSLANOĞLU','ELİF DULUNDU','ŞEVVAL ÖZTÜRK','DERİN HOBAT','MUSTAFA ALTUĞ YAĞIZ','DEFNE ZENAN ÖZEN'];
      G['M']=['LİNA ÖZTAN','DEVRİM ÖZGER','MUSTAFA YAĞIZ AVCI','ELİF KILINÇ','TANEM LÂL KAVAKLI','EREN TURANBARANOĞLU','SERRA SIRDAŞ','ATA İRGİ','DORA ILGIN GÜRSOY'];
      G['N']=['MELİH BURAK YAĞAR','DORUK ÇETİN','NİSA ÖZVARDAR','ELİS DEMİR','YUSUF EREN','GÜNEY DÜZGÜN','ZEYNEP ZÜLEYHA GEYİK','ATA YILMAZ ŞAHİN','EMİR TURANBARANOĞLU'];
      G['O']=['MERCAN GÖZÜKÜÇÜK','DORUK DUYMAÇ','ÖMER SADETTİN KELEŞ','GÖKÇE TABAK','HELEN SEREZ','ZEYNEP HEVİN BİLGE','AYŞE BEREN ULU','KEREM ÜNAL','YAĞMUR SEZER'];

      leagueData = { groups:{}, fixtures:{}, results:{} };
      Object.keys(G).forEach(gr=>{
        leagueData.groups[gr]=G[gr];
        leagueData.fixtures[gr]=generateFixtures(gr);
      });
    }

    // ---- Grupları menülere koy ----
    function populateGroupSelects(){
      const fixSel = document.getElementById('fixtureGroupSelect');
      const staSel = document.getElementById('standingsGroupSelect');
      fixSel.innerHTML = '<option value="">Grup seçin...</option>';
      staSel.innerHTML = '<option value="">Grup seçin...</option>';
      'ABCDEFGHIJKLMNO'.split('').forEach(g=>{
        const members = (leagueData.groups[g]||[]).filter(x=>x&&x.trim()!=='');
        if(members.length){
          const o1=document.createElement('option'); o1.value=g; o1.textContent='Grup '+g; fixSel.appendChild(o1);
          const o2=document.createElement('option'); o2.value=g; o2.textContent='Grup '+g; staSel.appendChild(o2);
        }
      });
    }

    // ---- Fikstür üret (round-robin) ----
    function generateFixtures(group){
      const members = (leagueData?.groups?.[group]) ? leagueData.groups[group] : (arguments.length===1?[]:group);
      const teams = Array.isArray(members)?members.filter(m=>m.trim()!==''):members;
      const n = teams.length; if(n<2) return [];
      const weeks = (n%2===0)?n-1:n;
      const fixtures = Array.from({length:weeks}, (_,i)=>({week:i+1,matches:[]}));
      let id=0;
      const all=[];
      for(let i=0;i<n;i++)for(let j=i+1;j<n;j++)all.push({id:`${group}_${id++}`,home:teams[i],away:teams[j]});
      let wi=0;
      for(const m of all){
        let placed=false, tries=0;
        while(!placed && tries<weeks){
          const w=fixtures[wi], used=new Set();
          w.matches.forEach(mm=>{used.add(mm.home); used.add(mm.away);});
          if(!used.has(m.home)&&!used.has(m.away)){ w.matches.push(m); placed=true; }
          wi=(wi+1)%weeks; tries++;
        }
      }
      return fixtures;
    }

    // ---- Fikstür göster ----
    function showFixtures(){
      const g=document.getElementById('fixtureGroupSelect').value;
      const el=document.getElementById('fixtureContent');
      if(!g){ el.innerHTML='<p class="text-gray-500">Lütfen bir grup seçin.</p>'; return; }
      if(!leagueData.fixtures[g]) leagueData.fixtures[g]=generateFixtures(g);
      const fx=leagueData.fixtures[g];
      el.innerHTML = `
        <div class="space-y-6">
          ${fx.map(w=>`
            <div class="border border-gray-200 rounded-lg p-4">
              <h3 class="font-bold text-lg mb-3 text-indigo-700">${w.week}. Hafta</h3>
              <div class="space-y-2">
                ${w.matches.map(m=>`
                  <div class="flex items-center space-x-2 bg-gray-50 p-3 rounded">
                    <span class="flex-1 text-right font-medium">${m.home}</span>
                    <input type="number" value="${leagueData.results[m.id]?.homeScore??''}"
                      onchange="updateScore('${m.id}','homeScore',this.value)" class="w-12 text-center border rounded px-2 py-1">
                    <span class="text-gray-500">-</span>
                    <input type="number" value="${leagueData.results[m.id]?.awayScore??''}"
                      onchange="updateScore('${m.id}','awayScore',this.value)" class="w-12 text-center border rounded px-2 py-1">
                    <span class="flex-1 font-medium">${m.away}</span>
                  </div>`).join('')}
              </div>
            </div>`).join('')}
        </div>`;
    }

    function updateScore(matchId,key,val){
      if(!leagueData.results[matchId]) leagueData.results[matchId]={};
      leagueData.results[matchId][key]=val===''?'':(parseInt(val)||0);
      saveData();
      const g=matchId.split('_')[0];
      if(document.getElementById('standingsGroupSelect').value===g) showStandings();
    }

    // ---- Puan Durumu ----
    function calculateStandings(g){
      const members=(leagueData.groups[g]||[]).filter(m=>m.trim()!=='');
      const s=members.map(n=>({name:n,played:0,won:0,drawn:0,lost:0,correct:0,wrong:0,goalDifference:0,points:0}));
      Object.keys(leagueData.results).forEach(id=>{
        if(!id.startsWith(g+'_')) return;
        const r=leagueData.results[id];
        if(r.homeScore===''||r.awayScore===''||r.homeScore==null||r.awayScore==null) return;
        const hs=parseInt(r.homeScore)||0, as=parseInt(r.awayScore)||0;
        const fx=leagueData.fixtures[g]||[]; let home,away;
        fx.forEach(w=>w.matches.forEach(m=>{ if(m.id===id){home=m.home;away=m.away;} }));
        const hi=s.findIndex(x=>x.name===home), ai=s.findIndex(x=>x.name===away);
        if(hi<0||ai<0) return;
        s[hi].played++; s[ai].played++;
        s[hi].correct+=hs; s[hi].wrong+=as;
        s[ai].correct+=as; s[ai].wrong+=hs;
        if(hs>as){ s[hi].won++; s[hi].points+=3; s[ai].lost++; }
        else if(hs<as){ s[ai].won++; s[ai].points+=3; s[hi].lost++; }
        else { s[hi].drawn++; s[ai].drawn++; s[hi].points++; s[ai].points++; }
        s[hi].goalDifference=s[hi].correct-s[hi].wrong;
        s[ai].goalDifference=s[ai].correct-s[ai].wrong;
      });
      s.sort((a,b)=>(b.points-a.points)||(b.goalDifference-a.goalDifference)||(b.correct-a.correct));
      return s;
    }

    function showStandings(){
      const g=document.getElementById('standingsGroupSelect').value;
      const el=document.getElementById('standingsContent');
      if(!g){ el.innerHTML='<p class="text-gray-500">Lütfen bir grup seçin.</p>'; return; }
      const s=calculateStandings(g); const qualify = 4;
      el.innerHTML = `
        <div class="overflow-x-auto">
          <table class="w-full border-collapse border border-gray-300">
            <thead>
              <tr class="bg-indigo-600 text-white">
                <th class="border px-3 py-2 text-center">Sıra</th>
                <th class="border px-3 py-2 text-left">Öğrenci</th>
                <th class="border px-3 py-2 text-center">O</th>
                <th class="border px-3 py-2 text-center">G</th>
                <th class="border px-3 py-2 text-center">B</th>
                <th class="border px-3 py-2 text-center">M</th>
                <th class="border px-3 py-2 text-center">P</th>
              </tr>
            </thead>
            <tbody>
              ${s.map((t,i)=>`
                <tr class="${i<qualify?'qualified':''}">
                  <td class="border px-3 py-2 text-center font-bold">${i+1}</td>
                  <td class="border px-3 py-2 font-medium">${t.name}</td>
                  <td class="border px-3 py-2 text-center">${t.played}</td>
                  <td class="border px-3 py-2 text-center">${t.won}</td>
                  <td class="border px-3 py-2 text-center">${t.drawn}</td>
                  <td class="border px-3 py-2 text-center">${t.lost}</td>
                  <td class="border px-3 py-2 text-center font-bold">${t.points}</td>
                </tr>`).join('')}
            </tbody>
          </table>
          <div class="mt-4 text-sm text-gray-600">
            <div class="flex items-center space-x-2">
              <div class="w-4 h-4 bg-green-200 border border-green-300"></div>
              <span>Bir sonraki tura çıkan öğrenciler (İlk ${qualify})</span>
            </div>
          </div>
        </div>`;
    }

    // ---- Sekme kontrolü ----
    function showTab(name, btn){
      document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
      document.getElementById(name).classList.add('active');
      document.querySelectorAll('.tab-btn').forEach(b=>{ b.classList.remove('text-indigo-600','border-b-2','border-indigo-600'); b.classList.add('text-gray-500'); });
      if(btn){ btn.classList.remove('text-gray-500'); btn.classList.add('text-indigo-600','border-b-2','border-indigo-600'); }
      if(name==='fixtures') showFixtures(); else if(name==='standings') showStandings();
    }

    // ---- Init ----
    document.addEventListener('DOMContentLoaded', ()=>{
      loadData(); createDownloadableBackup();
      // Puan Durumu sekmesine ilk uygun grubu seç
      const sel=document.getElementById('standingsGroupSelect');
      if(sel && sel.options.length>1){ sel.selectedIndex=1; showStandings(); }
    });
  </script>
</body>
</html>
